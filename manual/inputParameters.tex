\chapter{Input Parameters}
\label{ch:input}

\newcommand{\param}[5]{{\setlength{\parindent}{0cm} {\ttfamily \bfseries \hypertarget{#1}{#1}}\\{\it Type}: #2\\{\it Default}: #3\\{\it When it matters}: #4\\{\it Meaning}: #5}}
\newcommand{\myhrule}{{\setlength{\parindent}{0cm} \hrulefill }}

\newcommand{\true}{{\ttfamily .true.}}
\newcommand{\false}{{\ttfamily .false.}}

In this section we describe all the parameters which can be included in the input namelist. 

\section{General parameters}

\param{general\_option}
{integer}
{1}
{Always}
{Determines the overall flow of program execution.\\

{\ttfamily general\_option} = 1: Compute the current potential for a range of $\lambda$.\\

{\ttfamily general\_option} = 2: Do not compute the current potential, but rather load the current potential computed
by \nescoil~in the file \parlink{nescout\_filename}, compute the $\chi^2_B$ and $\chi^2_K$ for it,
and save results. For this setting, \parlink{Nlambda} will be over-written with the number of
current potential solutions found in the nescout file.\\

{\ttfamily general\_option} = 3: Emulate \nescoil's truncated singular value decomposition (TSVD) solver.
The least-squares problem solved will be minimization of only $\chi^2_B$ (i.e. $\lambda=0$.)
Output quantities will be saved in the same arrays as if $\lambda$ were scanned.
For this setting, \parlink{Nlambda} will be over-written with the number of
singular values.\\

{\ttfamily general\_option} = 4: Search for a value of the regularization weight such that
a certain target is met. The target is chosen using \parlink{target\_option}.
Use this value of {\ttfamily general\_option} for running \regcoil~inside
a fixed-boundary plasma shape optimization, in which case {\ttfamily chi2\_B\_target}
is the objective function you should minimize in the optimization.\\

{\ttfamily general\_option} = 5: Same as 4, except that before the $\lambda$ search is carried out,
the system is solved
for $\lambda=0$ and $\lambda=\infty$ to check whether the current density target is attainable.
Thus, this option takes a little more time than {\ttfamily general\_option}=4 but is more robust.
}

\myhrule

\param{nescout\_filename}
{string}
{`'}
{Only when \parlink{general\_option}=2.}
{Name of a \nescoil~output file which can be read in for processing.
}

\myhrule

\param{symmetry\_option}
{integer}
{1}
{Always}
{Determines whether stellarator symmetry is imposed.\\

{\ttfamily symmetry\_option} = 1: Force the single-valued part of the current potential
to be odd in $\theta$ and $\zeta$. This option corresponds to stellarator symmetry.\\

{\ttfamily symmetry\_option} = 2: Force the single-valued part of the current potential
to be even in $\theta$ and $\zeta$. I'm not sure why you would ever use this option,
but it is available for completeness.\\

{\ttfamily symmetry\_option} = 3: No symmetry in the current potential is imposed.
}

\myhrule

\param{save\_level}
{integer}
{3}
{Always}
{Option related determining how many variables are saved in the \netCDF~output file.  The larger the value, the smaller the output file.\\

{\ttfamily save\_level} = 0: Save everything.\\

{\ttfamily save\_level} = 1: Do not save the inductance matrix.\\

{\ttfamily save\_level} = 2: Also do not save the matrix $g$.\\

{\ttfamily save\_level} = 3: Also do not save the normal vector or derivatives of the position vector.
}

\myhrule

\param{load\_bnorm}
{logical}
{\false}
{When \parlink{general\_option}=1 or 3.}
{Whether or not an output file from the \bnorm~code is to be loaded.
Set this option to \true~if there is significant current in the plasma,
meaning the coils will need to cancel the associated magnetic field component normal
to the target plasma surface.
}

\myhrule

\param{bnorm\_filename}
{string}
{`'}
{When \parlink{general\_option}=1 or 3 and \parlink{load\_bnorm}=\true.}
{Output file from the \bnorm~code which contains the magnetic field normal to the target
plasma surface associated with current inside the plasma.}

\myhrule

\param{net\_poloidal\_current\_Amperes}
{real}
{1.0}
{If \parlink{geometry\_option\_plasma}=0,1,or 5, i.e. if the plasma surface is not a vmec equilibrium.}
{The number of Amperes of current the links the coil winding surface poloidally,
denoted $G$ in \cite{regcoilPaper}. If the plasma surface is obtained from a vmec equilibrium,
then {\ttfamily net\_poloidal\_current\_Amperes} will be determined instead
from the {\ttfamily bvco} value in the vmec wout file.
}

\myhrule

\param{net\_toroidal\_current\_Amperes}
{real}
{0.0}
{Always}
{The number of Amperes of current the links the coil winding surface toroidally,
denoted $I$ in \cite{regcoilPaper}. Unlike the net poloidal current, this number
is never read from a wout file.
}



\section{Resolution parameters}

For any new set of surface geometries you consider, you should vary the resolution parameters in this section to make sure
they are large enough.  These parameters should be large enough that the code results you care about are unchanged under further
resolution increases.

\myhrule

\param{ntheta\_plasma}
{integer}
{64}
{Always}
{Number of grid points in poloidal angle used to evaluate surface integrals on the plasma surface.
Often 64 or 128 is a good value.
It is resonable and common but not mandatory to use the same value for {\ttfamily ntheta\_plasma} and \parlink{ntheta\_coil}.}

\myhrule

\param{ntheta\_coil}
{integer}
{64}
{Always}
{Number of grid points in poloidal angle used to evaluate surface integrals on the coil winding surface.
Often 64 or 128 is a good value.
It is resonable and common but not mandatory to use the same value for \parlink{ntheta\_plasma} and {\ttfamily ntheta\_coil}.}

\myhrule


\param{nzeta\_plasma}
{integer}
{64}
{Always}
{Number of grid points in toroidal angle used to evaluate surface integrals on the plasma surface.
Often 64 or 128 is a good value.
It is resonable and common but not mandatory to use the same value for {\ttfamily nzeta\_plasma} and \parlink{nzeta\_coil}.}

\myhrule

\param{nzeta\_coil}
{integer}
{64}
{Always}
{Number of grid points in toroidal angle used to evaluate surface integrals on the coil winding surface.
Often 64 or 128 is a good value.
It is resonable and common but not mandatory to use the same value for \parlink{nzeta\_plasma} and {\ttfamily nzeta\_coil}.}

\myhrule

\param{mpol\_coil}
{integer}
{12}
{Always}
{Maximum poloidal mode number to include for the single-valued part of the current potential on the coil winding surface.
}

\myhrule

\param{ntor\_coil}
{integer}
{12}
{Always}
{
Maximum toroidal mode number to include for the single-valued part of the current potential on the coil winding surface.
}

\myhrule

\param{mpol\_transform\_refinement}
{real}
{5.0}
{Only when \parlink{geometry\_option\_plasma} is 4.}
{The number of poloidal mode numbers in the \vmec~file will be multiplied by this value
when transforming from the original poloidal angle to the straight-field-line angle.
Since the original \vmec~angle is chosen to minimize the number of Fourier modes required,
more modes are required in any other coordinate.
This parameter affects the time required to compute constant-offset surfaces,
but does not affect the time for other calculations.
}

\myhrule

\param{ntor\_transform\_refinement}
{real}
{1.0}
{Only when \parlink{geometry\_option\_plasma} is 4.}
{The number of toroidal mode numbers in the \vmec~file will be multiplied by this value
when transforming from the original poloidal angle to the straight-field-line angle.
Since the original \vmec~angle is chosen to minimize the number of Fourier modes required,
more modes are required in any other coordinate.
This parameter affects the time required to compute constant-offset surfaces,
but does not affect the time for other calculations.
}

\section{Geometry parameters for the plasma surface}

\param{geometry\_option\_plasma}
{integer}
{0}
{Always}
{This option controls how you specify the shape of the target plasma surface.\\

{\ttfamily geometry\_option\_plasma} = 0: The plasma surface will be a plain circular torus. The major radius will be \parlink{R0\_plasma}.
     The minor radius will be \parlink{a\_plasma}. This option exists just for testing purposes.\\

{\ttfamily geometry\_option\_plasma} = 1: Identical to option 0.\\

{\ttfamily geometry\_option\_plasma} = 2: The plasma surface will be the last surface in the full radial grid of the \vmec~file specified by \parlink{wout\_ilename}.
The poloidal angle used will be the normal \vmec~angle which is not a straight-field-line coordinate.
This is typically the best option to use for working with \vmec~equilibria.\\

{\ttfamily geometry\_option\_plasma} = 3: The plasma surface will be the last surface in the half radial grid of the \vmec~file specified by \parlink{wout\_filename}.
The poloidal angle used will be the normal \vmec~angle which is not a straight-field-line coordinate.
This option exists so that the same flux surface can be used when comparing with {\ttfamily geometry\_option\_plasma} = 4.\\

{\ttfamily geometry\_option\_plasma} = 4: The plasma surface will be the last surface in the half radial grid of the \vmec~file specified by \parlink{wout\_filename}.
The poloidal angle used will be the straight-field-line coordinate, obtained by shifting the normal \vmec~poloidal angle by \vmec's $\lambda$ quantity.
This option exists in order to examine changes when using a different poloidal coordinate compared to {\ttfamily geometry\_option\_plasma} = 3.\\

{\ttfamily geometry\_option\_plasma} = 5: The plasma surface will be the flux surface with normalized poloidal flux
\parlink{efit\_psiN} taken from the {\ttfamily efit} file specified by \parlink{efit\_filename}. \\

{\ttfamily geometry\_option\_plasma} = 6: The plasma surface will be loaded from an ASCII file, specified by \parlink{shape\_filename\_plasma}. The first line of this file is ignored. The second line is an integer giving the number of Fourier modes
to read. The remaining lines contain $m$, $n$, $rmnc$, $zmns$, $rmns$, $zmnc$.
}

\myhrule

\param{shape\_filename\_plasma}
{string}
{`'}
{Only when \parlink{geometry\_option\_plasma} is 6.}
{ASCII file from which to read in the plasma shape.}

\myhrule

\param{R0\_plasma}
{real}
{10.0}
{Only when \parlink{geometry\_option\_plasma} is 0 or 1.}
{Major radius of the plasma surface, when this surface is a plain circular torus.}

\myhrule

\param{a\_plasma}
{real}
{0.5}
{Only when \parlink{geometry\_option\_plasma} is 0 or 1.}
{Minor radius of the plasma surface, when this surface is a plain circular torus.}

\myhrule

\param{nfp\_imposed}
{integer}
{1}
{Only when \parlink{geometry\_option\_plasma} is 0 or 1.}
{When the plasma surface is a plain circular torus, only toroidal mode numbers that are a multiple of this parameter will be considered.
This parameter thus plays a role like \vmec's {\ttfamily nfp} (number of field periods),
and is used when {\ttfamily nfp} is not already loaded from a \vmec~file.}

\myhrule

\param{wout\_filename}
{string}
{`'}
{Only when \parlink{geometry\_option\_plasma} is 2, 3, or 4.}
{Name of the \vmec~{\ttfamily wout} output file which will be used for the plasma surface.
You can use either a \netCDF~or {\ttfamily ASCII} format file.}

\myhrule

\param{efit\_filename}
{string}
{`'}
{Only when \parlink{geometry\_option\_plasma} is 5.}
{Name of the {\ttfamily efit} output file which will be used for the plasma surface.}

\myhrule

\param{efit\_psiN}
{real}
{0.98}
{Only when \parlink{geometry\_option\_plasma} is 5.}
{Value of normalized poloidal flux at which to select a flux surface from the {\ttfamily efit} input file.
A value of 1 corresponds to the last closed flux surface, and 0 corresponds to the magnetic axis.}

\myhrule

\param{efit\_num\_modes}
{integer}
{10}
{Only when \parlink{geometry\_option\_plasma} is 5.}
{Controls the number of Fourier modes used to represent $R(\theta)$ and $Z(\theta)$ for the shape of
the plasma surface. Each of these functions will be expanded in a sum of functions $\sin(m\theta)$ and $\cos(m\theta)$,
where $m$ ranges from 0 to {\ttfamily efit\_num\_modes}$-1$.}

\section{Geometry parameters for the coil winding surface}

\param{geometry\_option\_coil}
{integer}
{0}
{Always}
{This option controls which type of geometry is used for the coil surface.\\

{\ttfamily geometry\_option\_coil} = 0: The coil surface will be a plain circular torus. The major radius will be the 
same as the plasma surface: either \parlink{R0\_plasma} if \parlink{geometry\_option\_plasma} is 0 or 1, or {\ttfamily Rmajor\_p} from the \vmec~{\ttfamily wout} file
if  \parlink{geometry\_option\_plasma} is 2.
     The minor radius will be \parlink{a\_coil}.\\

{\ttfamily geometry\_option\_coil} = 1: Identical to option 0, except the major radius of the coil surface will be set by \parlink{R0\_coil}.\\

{\ttfamily geometry\_option\_coil} = 2: The coil surface will computing by expanding the plasma surface uniformly by a distance \parlink{separation}.\\

{\ttfamily geometry\_option\_coil} = 3: The coil surface will be the `coil' surface in the \nescoil~`nescin' input file specified by \parlink{nescin\_filename}.
}

\myhrule

\param{R0\_coil}
{real}
{10.0}
{Only when \parlink{geometry\_option\_coil} is 1.}
{Major radius of the coil surface, when this surface is a plain circular torus.}

\myhrule

\param{a\_coil}
{real}
{1.0}
{Only when \parlink{geometry\_option\_coil} is 0 or 1.}
{Minor radius of the coil surface, when this surface is a plain circular torus.}


\myhrule

\param{separation}
{real}
{0.2}
{Only when \parlink{geometry\_option\_coil} is 2.}
{Amount by which the coil surface is offset from the plasma surface.}

\myhrule

\param{nescin\_filename}
{string}
{`'}
{Only when \parlink{geometry\_option\_coil} is 3.}
{Name of a \nescoil~{\ttfamily nescin} input file. The coil surface from
this file will be used as the coil surface for \regcoil.}

\myhrule

\param{save\_nescin\_option}
{integer}
{0}
{When \parlink{geometry\_option\_coil = 2}.}
{Determines whether or not to save the offset surface coefficients in nescin format. Stellarator symmetry is assumed. \\
{\ttfamily save\_nescin\_option} = 0: No nescin file is saved. \\
{\ttfamily save\_nescin\_option} = 1: Nescin file is saved with name \texttt{nescin.offset}. }

\myhrule

\param{save\_nescin\_mpol}
{integer}
{12}
{When \parlink{save\_nescin\_option =1}. }
{Maximum poloidal Fourier mode number for the nescin file.}

\myhrule

\param{save\_nescin\_ntor}
{integer}
{12}
{When \parlink{save\_nescin\_option = 1}.}
{Maximum toroidal Fourier mode number for the nescin file.}


\section{Parameters related to the regularization weight}

\param{Nlambda}
{integer}
{4}
{Only when \parlink{general\_option}=1, 4, or 5.}
{When \parlink{general\_option}=1, {\ttfamily Nlambda} is the number of values of $\lambda$ for which the problem is solved.
When \parlink{general\_option}=4 or 5, {\ttfamily Nlambda} is the upper limit on the number of values of $\lambda$ for which the problem is solved.}

\myhrule

\param{lambda\_max}
{real}
{1.0e-13}
{Only when \parlink{general\_option}=1.}
{Maximum value of $\lambda$ for which the problem is solved.}

\myhrule

\param{lambda\_min}
{real}
{1.0e-19}
{Only when \parlink{general\_option}=1.}
{Minimum nonzero value of $\lambda$ for which the problem is solved.
Note that the problem is always solved for $\lambda=0$ in addition to
the nonzero values.}

\myhrule

\param{target\_option}
{integer}
{1}
{Only when \parlink{general\_option}=4 or 5.}
{Controls which target is used to find determine $\lambda$:\\

{\ttfamily target\_option} = 1: Search for the $\lambda$ value such that the root-mean-square current density
$\left( \int d^2a\; K^2 \right)^{1/2}$ equals \parlink{current\_density\_target}.\\

{\ttfamily target\_option} = 2: Search for the $\lambda$ value such that the maximum
current density over the winding surface equals \parlink{current\_density\_target}.\\

{\ttfamily target\_option} = 3: Search for the $\lambda$ value such that the $L^p$ norm of the current 
density over the winding surface equals \parlink{current\_density\_target}. Here $p$ is specified by 
\parlink{target\_option\_p}. The norm is defined in the following way.
\begin{gather}
\norm{\bm{K}}_p = \left( \frac{\int d \theta' \int d \zeta' \, (\abs{\bm{K}'}^2)^{p/2}}{(2\pi)^2} \right)^{1/p}
\end{gather}\\

{\ttfamily target\_option} = 4: Same as \parlink{target\_option} = 3, but $L^p$ norm is defined using a
surface integral.
\begin{gather}
\norm{\bm{K}}_p = \left( \frac{\int d \theta' \int d \zeta' \, N' (\abs{\bm{K}'}^2)^{p/2}}{\int d \theta' \int d \zeta' \, N'} \right)^{1/p}
\end{gather} \\

{\ttfamily target\_option} = 5: Same as \parlink{target\_option} = 3, but maximum is approximated in the following way.
\begin{gather}
\norm{\bm{K}}_p = \frac{ \int d \theta' \int d \zeta' \, (\abs{\bm{K}'}^2)^{(p+1)/2}}{  \int d \theta' \int d \zeta' \, (\abs{\bm{K}'}^2)^{p/2} }
\end{gather}

{\ttfamily target\_option} = 6: Same as \parlink{target\_option} = 3, but maximum is approximated in the following way.
\begin{gather}
\norm{\bm{K}}_p = \frac{ \int d \theta' \int d \zeta' \, N' (\abs{\bm{K}'}^2)^{(p+1)/2}}{  \int d \theta' \int d \zeta' \, N' (\abs{\bm{K}'}^2)^{p/2} }
\end{gather}

{\ttfamily target\_option} = 7: Same as \parlink{target\_option} = 3, but maximum is approximated using the log-sum-exponent norm. 
\begin{gather}
\norm{\bm{K}}_p = \frac{1}{p} \log\left( \frac{\int d \theta' \int d \zeta'  \exp (p \abs{\bm{K}'}^2 ) }{ (2 \pi)^2}\right)
\end{gather}

{\ttfamily target\_option} = 8: Same as \parlink{target\_option} = 3, but maximum is approximated using the following variant of the log-sum-exponent norm.
\begin{gather}
\norm{\bm{K}}_p = \frac{1}{p} \log \left( \frac{\int d \theta' \int d \zeta' \, N' \exp (p \abs{\bm{K}'}^2 ) }{ \int d \theta' \int d \zeta' \, N' }\right)
\end{gather}

{\ttfamily target\_option} = 9: $\chi^2_B$ is used as a target function.

}


\myhrule

\param{current\_density\_target}
{real}
{8.0e6}
{Only when \parlink{general\_option}$>3$.}
{The value of root-mean-square or maximum surface current density used to determine $\lambda$.
See \parlink{target\_option}.
As with all other input and output quantities, this surface current density is specified in SI units,
so the units are Amperes/meter.
}

\myhrule

\param{target\_option\_p}
{real}
{4.0}
{Only when \parlink{target\_option}=3, 4, 5, 6, 7, or 8.}
{The value of $p$ used for the $L^p$ norm to approximate the maximum of the current density over the
winding surface.}

\myhrule

\param{lambda\_search\_tolerance}
{real}
{1.0e-5}
{Only when \parlink{general\_option}=4 or 5.}
{Relative tolerance for the lambda root-finding.}

\myhrule

\param{L\_p\_diagnostic\_option}
{integer}
{1}
{Typically will be used with \parlink{target\_option} $> 2$ to determine a sufficient value for $p$.}
{
\texttt{L\_p\_diagnostic\_option} = 1: The $L^p$ norm of the current density is not computed. 
\texttt{L\_p\_diagnostic\_option} = 2: The $L^p$ norm of the current density will be computed
for a range of $p$. The norms defined as documented for \parlink{target\_option} $> 3$ are computed. 
}

\myhrule

\param{L\_p\_diagnostic\_min}
{real}
{4.0}
{When \parlink{L\_p\_diagnostic\_option} = 2.}
{
The minimum value of $p$ to use for computing the $L^p$ norm of the current density.
}

\myhrule

\param{L\_p\_diagnostic\_max}
{real}
{16.0}
{When \parlink{L\_p\_diagnostic\_option} = 2.}
{
The maximum value of $p$ to use for computing the $L^p$ norm of the current density.
}

\myhrule

\param{L\_p\_diagnostic\_np}
{integer}
{4}
{When \parlink{L\_p\_diagnostic\_option} = 2.}
{
Number of values of $p$ to use for compute the $L^p$ norm of the current density. 
}

\myhrule

\section{Parameters Related to Sensitivity \& Adjoint Solve}

\myhrule

\param{sensitivity\_option}
{integer}
{1}
{If gradients with respect to coil geometry parameters are desired.}
{\\ \texttt{sensitivity\_option = 3,4,5} should give the same results, though \texttt{sensitivity\_option} = 4 or 5 tends to be the most efficient. \\ \\
\texttt{sensitivity\_option = 1}: No sensitivity information is computed. \\ \\
\texttt{sensitivity\_option = 2}: Sensitivity of $\chi^2$ is computed. The same range of $\lambda$ is used as that designated by \parlink{Nlambda}, \parlink{lambda\_max}, and \parlink{lambda\_min}. \\ \\
\texttt{sensitivity\_option = 3}: Sensitivity of $\chi^2_K$ and $\chi^2_B$ are computed in addition to that of $\chi^2$. This requires two adjoint solves. \\ \\
\texttt{sensitivity\_option = 4}: Sensitivity of $\chi^2_K$ and $\chi^2_B$ are computed in addition to that of $\chi^2$. An adjoint solve is used to compute the sensitivity of $\chi^2_K$, and the sensitivity of $\chi^2_B$ is computed by subtracting $\lambda \partder{\chi^2_K}{\Omega}$ from $\partder{\chi^2}{\Omega}$. This requires one adjoint solve. \\ \\
\texttt{sensitivity\_option = 5}: Sensitivity of $\chi^2_K$ and $\chi^2_B$ are computed in addition to that of $\chi^2$. An adjoint solve is used to compute the sensitivity of $\chi^2_B$, and the sensitivity of $\chi^2_K$ is computed by subtracting $\partder{\chi^2_B}{\Omega}$ from $\partder{\chi^2}{\Omega}$ and dividing by $\lambda$. 
}
%\texttt{sensitivity_option == 2}: Sensitivity of $\chi^2$ is computed. The same $\lambda$ is used as that designated by \parlink{Nlambda}, \parlink{lambda\_max}, and \parlink{lambda\_min}. 
%}

\myhrule

\param{nmax\_sensitivity}
{integer}
{0}
{When \parlink{sensitivity\_option} $> 1$.}
{Sensitivity of $\chi^2$, $\chi^2_B$, and $\chi^2_K$ will be computed with respect to $r_{mn}^c$ and $z_{mn}^s$ for $\abs{n} \leq $ \texttt{nmax\_sensitivity}.}

\myhrule

\param{mmax\_sensitivity}
{integer}
{0}
{When \parlink{sensitivity\_option} $> 1$.}
{Sensitivity of $\chi^2$, $\chi^2_B$, and $\chi^2_K$ will be computed with respect to $r_{mn}^c$ and $z_{mn}^s$ for $m \leq $ \texttt{nmax\_sensitivity}.}

\myhrule

\param{sensitivity\_symmetry\_option}
{integer}
{1}
{When \parlink{sensitivity\_option} $> 1$.}
{Symmetry assumed when computed sensitivity to coil geometry parameters. This does not need to be the same as \parlink{symmetry\_option}. \\
{\ttfamily sensitivity\_symmetry\_option} = 1: Only compute derivatives with respect to $r_{mn}^c$ and $z_{mn}^s$ of the winding surface using the \texttt{NESCIN} convention. This option corresponds to stellarator symmetry.\\

{\ttfamily sensitivity\_symmetry\_option} = 2: Only compute derivatives with respect to $r_{mn}^s$ and $z_{mn}^c$ of the winding surface using the \texttt{NESCIN} convention. I'm not sure why you would ever use this option,
but it is available for completeness.\\

{\ttfamily sensitivity\_symmetry\_option} = 3: No symmetry in the winding surface is imposed. 
}

\myhrule

\param{fixed\_norm\_sensitivity\_option}
{integer}
{1}
{When \parlink{sensitivity\_option} $> 1$ and \parlink{target\_option} = 4, 8, or 9.}
{If \parlink{fixed\_norm\_sensitivity\_option} $>1$, gradients of $\chi^2$ are computed at fixed $\norm{\bm{K}}_p$ rather than fixed $\lambda$. This option must be used with \parlink{general\_option} $> 3$ and  \parlink{target\_option} = 4, 8, or 9. If \parlink{sensitivity\_option} $>2$, then gradients of $\chi^2_K$ and $\chi^2_B$ will also be computed at the fixed target. 
}

\myhrule

\param{coil\_plasma\_dist\_lse\_p}
{real}
{1e4}
{When \parlink{sensitivity\_option} $> 1$.}
{If \parlink{sensitivity\_option} $>1$, the sensitivity of the log-sum-exponent approximation to the coil-plasma distance will be computed. The value of \parlink{coil\_plasma\_dist\_lse\_p} determines the scaling, $p$, in the exponent for this form of the distance.
\begin{gather}
\min d = - \frac{1}{p} \log \left( \frac{ \int_{\text{coil}} d^2 A \, \int_{\text{plasma}} d^2 A \, \exp \left( - p \sqrt{ (\bm{r}_{\text{coil}} - \bm{r}_{\text{plasma}})^2 } \right) }{A_{\text{coil}} A_{\text{plasma}}} \right)
\end{gather}
}

\myhrule

\chapter{Winding Surface Optimization with Adjoint \texttt{REGCOIL}}
\label{ch:adjoint}

In this section we describe winding surface optimization using the adjoint \texttt{REGCOIL} method. 

\section{Overview}

If an adjoint equation is solved in \texttt{REGCOIL}, (\parlink{sensitivity\_option} $> 1$), then analytic derivatives of $\chi^2_B$, $\norm{\bm{K}}_2$, or $K_{\max}$ are computed with respect to the Fourier coefficients defining the winding surface using the adjoint method. These derivatives are used for a gradient-based optimization method to find a winding surface which minimizes a user-defined objective function. The target plasma surface is held fixed during the optimization. The user has the option of holding a target function fixed during the optimization (such as $\chi^2_B$, $\norm{\bm{K}}_2$, or $K_{\max}$) to fix the regularization parameter $\lambda$. There are also options to impose constraints, such as on the minimum coil-plasma distance. The \texttt{NESCIN} convention is used, and the result of the optimization is a \texttt{NESCIN} file with the optimal winding surface Fourier coefficients. 

\section{Optimization scripts}
In addition to the \texttt{\&regcoil} namelist, the \texttt{\&regcoilOptimize} namelist must be included. The parameters in this namelist are read by either the \texttt{scipy\_optimize} or \texttt{nlopt\_optimize} python scripts, found in the \texttt{coilOptimizationTools} directory. These scripts are called with the \texttt{REGCOIL} input file as an argument. The \texttt{REGCOIL} input file in addition to any geometry files (\texttt{nescin\_filename}, \texttt{efit\_filename}, \texttt{bnorm\_filename}, \texttt{shape\_filename\_plasma}) must be located in the directory from which these scripts are called. 

The \texttt{nlopt} package must be installed in order to call \texttt{nlopt\_optimize}. See the \href{https://nlopt.readthedocs.io/en/latest/#download-and-installation}{nlopt documentation} for installation instructions. In general \texttt{nlopt\_optimize} should be used if one wants to perform constrained optimization. The \texttt{scipy\_optimze} script utilizes the \texttt{scipy.optimize} package. Details on installation of \texttt{scipy} can be found \href{https://scipy.org/install.html}{here}. The parameters relevant to each of these scripts are detailed below. 

Each time that \texttt{REGCOIL} is called from one of the scripts, an \texttt{eval\_} directory will be created. The script will print the objective function and constraint functions diagnostics with each evaluation to standard output. The \texttt{compareRegcoilSurface} script can be called on two regcoil output files to compare the winding surfaces at 2 evaluations. Several example input files can be found in the \texttt{adjointRegcoilExamples} directory.

\section{Required \texttt{\&regcoil} namelist parameters}
The following items in the \texttt{\&regcoil} namelist should be used when running adjoint \texttt{REGCOIL}. 
\begin{itemize}
\item \parlink{geometry\_option\_coil} = 3 
    \begin{itemize}
    \item A \parlink{nescin\_filename} must be specified. It is assumed that the $m=0$ mode only includes $n\geq0$ modes. 
    \end{itemize}
\item \parlink{sensitivity\_option} $>1$ denotes an adjoint solve must be performed. If $\chi^2_B$, $\norm{\bm{K}}_2$ or $K_{\text{max}}$ are included in the objective function, \parlink{sensitivity\_option} should be $>2$. If finite difference derivatives are used by setting \parlink{grad\_option} = 1 or if $\chi^2_B$, $\norm{\bm{K}}_2$ or $K_{\text{max}}$ are not included in the objective function, \parlink{sensitivity\_option} can be set to one. 
\item \parlink{nmax\_sensitivity} should be set to the largest value of $n$ that should be varied in the \texttt{NESCIN} file. This matters if \parlink{sensitivity\_option} $>1$.
\item \parlink{nmax\_sensitivity} should be set to the largest value of $m$ that should be varied in the \texttt{NESCIN} file. This matters if \parlink{sensitivity\_option} $>1$.
\item \parlink{sensitivity\_symmetry\_option} should be set to reflect the symmetry desired in the optimized winding surface. 
\item If the coil-plasma distance is to be included in the objective function or constraints, then \parlink{coil\_plasma\_dist\_lse\_p} should be set to the desired value for the log-sum-exponent approximation. A value in the range $10^{2}$ - $10^4$ is typically sufficient. At very large values the function has very steep gradients, while at small values it does not approximate the minimum function well. 
\item If the gradients of $\chi^2_B$, $\norm{\bm{K}}_2$ or $K_{\text{max}}$  are to be computed at fixed $\norm{\bm{K}}_p$ (rather than at fixed $\lambda$), \parlink{fixed\_norm\_sensitivity\_option} should be $>1$. The following parameters matter when \parlink{fixed\_norm\_sensitivity\_option} $>1$. 
	\begin{itemize}
	\item \parlink{target\_option} must be 4, 8, or 9. 
	\item \parlink{target\_option\_p} is a parameter in the norm defined by \parlink{target\_option}
	\end{itemize}
\end{itemize}

\section{Coil-winding Surface Optimization Parameters}

\myhrule

The parameters related to winding surface optimization are defined in the \texttt{regcoilOptimize} namelist of the input file. 

\myhrule

\section{Winding Surface Optimization}

The following objective function is used when \texttt{nlopt\_optimize} or \texttt{scipy\_optimize} is called.
\begin{gather}
f = \texttt{scale\_factor} \left( -\alpha_V V_{\text{coil}} + \alpha_S S_p - \alpha_D d_{\text{min}} + \alpha_B \chi^2_B + \alpha_K \norm{\bm{K}}_2 + \alpha_{\max K} K_{\max} \right)
\end{gather}
Here $S_p$ is the spectral width,
\begin{gather}
S_p = \sum_{m,n} m^p \left( \left(r_{mn}^c\right)^2 + \left(z_{mn}^s\right)^2 \right),
\label{spectral_width}
\end{gather}
$d_{\text{min}}$ is the minimum coil-plasma distance,
\begin{gather}
d_{\text{min}} = \min \left( \sqrt{ \left(\bm{r}_{\text{coil}} - \bm{r}_{\text{plasma}} \right)^2 } \right),
\end{gather}
and $\norm{\bm{K}}_2$ is the root-mean-squared current density,
\begin{gather}
\norm{\bm{K}}_2 = \sqrt{\chi^2_K/A_{\text{coil}}}.
\end{gather}
The coefficients in $f$ are defined by the user. 

\myhrule

\param{alphaV}
{float}
{0}
{When \texttt{nlopt\_optimize} or \texttt{scipy\_optimize} is being called.}
{Scaling factor for $V_{\text{coil}}$ in the objective function.}

\myhrule

\param{alphaS}
{float}
{0}
{When \texttt{nlopt\_optimize} or \texttt{scipy\_optimize} is being called.}
{Scaling factor for $S_p$ in the objective function.}

\myhrule

\param{alphaD}
{float}
{0}
{When \texttt{nlopt\_optimize} or \texttt{scipy\_optimize} is being called.}
{Scaling factor for $d_{\text{min}}$ in the objective function.}

\myhrule

\param{alphaB}
{float}
{0}
{When \texttt{nlopt\_optimize} or \texttt{scipy\_optimize} is being called.}
{Scaling factor for $\chi^2_B$ in the objective function.}

\myhrule

\param{alphaK}
{float}
{0}
{When \texttt{nlopt\_optimize} or \texttt{scipy\_optimize} is being called.}
{Scaling factor for $\norm{\bm{K}}_2$ in the objective function.}

\myhrule

\param{alphaMaxK}
{float}
{0}
{When \texttt{nlopt\_optimize} or \texttt{scipy\_optimize} is being called.}
{Scaling factor for $K_{\max}$ in the objective function.}

\myhrule

\param{scaleFactor}
{float}
{1}
{When \texttt{nlopt\_optimize} or \texttt{scipy\_optimize} is being called.}
{Scaling factor for objective function.}

\myhrule

\subsection{Scipy Optimize}

The following parameters are read if \texttt{scipy\_optimize} is being called. 

\param{scipy\_optimize\_method}
{string}
{CG}
{When \texttt{scipy\_optimize} is being called.}
{The method used by \texttt{scipy\_optimize}. The following gradient-based methods are available: CG, BFGS, Newton-CG, L-BFGS-B, TNC, SLSQP, dogleg, and trust-ncp. See the \\
\href{https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html}{scipy.optimize.minimize} documentation for more information.}

\myhrule

\param{grad\_option}
{integer}
{1}
{When \texttt{scipy\_optimize} is being called.}
{When \parlink{grad\_option} $ == 1$, the gradients computed by REGCOIL are used by \\ \texttt{scipy.optimize.minimize}. If \parlink{grad\_option} $ == 0$, a gradient function handle is not passed to \texttt{scipy.optimize}, and finite differencing is used.}

\myhrule

\param {maxiter}
{integer}
{1000}
{When \texttt{scipy\_optimize} is being called.}
{Maximum number of iteration to be taken by \texttt{scipy.optimize.minimize}.}

\myhrule

\param{norm}
{integer}
{2}
{When \texttt{scipy\_optimize} is being called.}
{Order of norm of the gradient used by \texttt{scipy.optimize.minimize} to determine successful termination.}

\myhrule

\param{gtol}
{float}
{$10^{-5}$}
{When \texttt{scipy\_optimize} is being called.}
{Tolerance for gradient norm required for termination.}

\myhrule

\param{nmax}
{integer}
{none}
{When \texttt{scipy\_optimize} is being called.}
{Maximum $n$ for Fourier modes of coil winding surface parameterization in \parlink{nescin\_filename}.}

\myhrule

\param{mmax}
{integer}
{none}
{When \texttt{scipy\_optimize} is being called.}
{Maximum $m$ for Fourier modes of coil winding surface parameterization in \parlink{nescin\_filename}.}

\myhrule

\subsection{NLOPT Optimize}

The following parameters are read if \texttt{nlopt\_optimize} is being called. 

\param{constraint\_min}
{integer}
{0}
{When \texttt{nlopt\_optimize} is being called.}
{\texttt{constraint\_min} = 0: No constraint on a minimum coil-plasma distance is enforced. \\
 \texttt{constraint\_min} = 1: Minimum coil-plasma distance is constrained to be $\leq$ \texttt{d\_min}. }
 
\myhrule

\param{d\_min}
{float}
{0.2}
{When \texttt{nlopt\_optimize} is being called and \texttt{contraint\_min} = 1.}
{Minimum coil-plasma allowed for optimized winding surface.}
 
 \myhrule
 
\param{constraint\_max\_K}
{integer}
{0}
{When \texttt{nlopt\_optimize} is being called.}
{\texttt{constraint\_max\_K} = 0: No constraint on $\max K$. \\
 \texttt{constraint\_max\_K} = 1: Maximum current density is constraint to be $\leq$ \texttt{max\_K}}
 
\myhrule

\param{max\_K}
{float}
{7.1e6}
{When \texttt{nlopt\_optimize} is being called and \texttt{contraint\_max\_K} = 1.}
{Maximum current density allowed during winding surface optimization. }

\myhrule

\param{constraint\_rms\_K}
{integer}
{0}
{When \texttt{nlopt\_optimize} is being called.}
{\texttt{constraint\_rms\_K} = 0: No constraint on $\norm{K}_2$. \\
 \texttt{constraint\_rms\_K} = 1: Maximum current density is constraint to be $\leq$ \texttt{rms\_K}}
 
\myhrule

\param{rms\_K}
{float}
{2.36e6}
{When \texttt{nlopt\_optimize} is being called and \texttt{contraint\_rms\_K} = 1.}
{Maximum current density allowed during winding surface optimization. }

\myhrule

\param{nlopt\_method}
{string}
{none}
{When \texttt{nlopt\_optimize} is being called. }
{Algorithm used for gradient based winding surface optimization. The following options are supported.
\begin{itemize}
\item \texttt{nlopt.G\_MLSL\_LDS}
\item \texttt{nlopt.LD\_LBFGS}
\item \texttt{nlopt.LD\_MMA}
\item \texttt{nlopt.LD\_SLSQP} 
\item \texttt{nlopt.LD\_CCSAQ}
\item \texttt{nlopt.LD\_TNEWTON\_PRECOND\_RESTART}
\item \texttt{nlopt.LD\_VAR1}
\end{itemize}
}

\myhrule

\param{omega\_min}
{float}
{-7}
{When \texttt{nlopt\_optimize} is being called. }
{Minimum value for $r_{mn}^c$ or $z_{mn}^s$ allowed for winding surface optimization.}

\myhrule

\param{omega\_max}
{float}
{7}
{When \texttt{nlopt\_optimize} is being called. }
{Maximum value for $r_{mn}^c$ or $z_{mn}^s$ allowed for winding surface optimization.}

\myhrule

\param{constraint\_tol}
{float}
{1e-6}
{When \texttt{nlopt\_optimize} is being called and \texttt{constraint\_min} =1 or \texttt{constraint\_max\_K} = 1 or \texttt{constraint\_rms\_K}.}
{Tolerance allowed for constraint equation to be satisfied.}

\myhrule

\param{ftol\_tol}
{float}
{1e-6}
{When \texttt{nlopt\_optimize} is being called.}
{Optimization will stop when the change in the objective function $f$ is less than \texttt{ftol\_tol} in successive steps.}

\myhrule

\param{nmax}
{integer}
{none}
{When \texttt{nlopt\_optimize} is being called.}
{Maximum $n$ value for winding surface Fourier modes in \texttt{nescin\_filename}.}

\myhrule

\param{mmax}
{integer}
{none}
{When \texttt{nlopt\_optimize} is being called.}
{Maximum $m$ value for winding surface Fourier modes in \texttt{nescin\_filename}.}

\section{General considerations and tips}
\begin{itemize}
\item The results of the optimization vary widely with the input parameters. It is suggested that a user perform low-resolution optimizations with varying parameters (such as $\alpha_B$, $\alpha_S$, $\alpha_{\max{K}}$, and $\alpha_V$). To begin, one can run the optimization for a few evaluations to ensure that it is descending in the desired direction. 
\item If \parlink{general\_option} = 4 or 5 (a $\lambda$ search is performed for a target function), it is not always possible to obtain a solution for $\lambda$ if the current density is too low or high. In this case, the optimization scripts adjust the \parlink{target\_current\_density} and will print a message to standard output. If you see that the \parlink{target\_current\_density} is readjusted several times, it is probably a good idea to begin the optimization with a different \parlink{target\_current\_density} . 
\item The SLSQP and CCSAQ algorithms in \texttt{nlopt} can be sensitive to the selection of \parlink{omega\_min} and \parlink{omega\_max}, as these set the initial step size for the optimization. If the winding surface wanders to far from the initial surface, these should be adjusted. 
\end{itemize}



